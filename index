<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Vox Syn</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body {
    margin: 0;
    font-family: sans-serif;
    background: #0f1115;
    color: #fff;
}
header {
    padding: 10px;
    background: #161a22;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
button, input {
    background: #222633;
    border: none;
    color: #fff;
    padding: 8px;
    border-radius: 6px;
}
button:hover { background: #2e3445; }
#videos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
    gap: 10px;
    padding: 10px;
}
video {
    width: 100%;
    background: #000;
    border-radius: 10px;
}
#chat {
    position: fixed;
    right: 0;
    top: 0;
    width: 300px;
    height: 100%;
    background: #161a22;
    display: flex;
    flex-direction: column;
}
#messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}
#messages div {
    margin-bottom: 6px;
}
#chat input {
    margin: 10px;
}
</style>
</head>
<body>

<header>
    <span>üÜî <b id="myId">...</b></span>
    <input id="name" placeholder="–ò–º—è">
    <input id="connectId" placeholder="Peer ID">
    <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="toggleMic()">üéôÔ∏è</button>
    <button onclick="shareScreen()">üñ•Ô∏è</button>
</header>

<div id="videos"></div>

<div id="chat">
    <div id="messages"></div>
    <input id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeydown="sendMessage(event)">
</div>

<script>
let peer;
let myStream;
let peers = {};
let dataChannels = {};
let isHost = true;
let screenStream = null;

async function init() {
    peer = new Peer();

    peer.on('open', id => {
        document.getElementById('myId').textContent = id;
    });

    peer.on('call', call => {
        call.answer(myStream);
        setupCall(call);
    });

    peer.on('connection', conn => {
        setupData(conn);
    });

    myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
}
init();

function setupCall(call) {
    peers[call.peer] = call;

    call.on('stream', stream => {
        addVideo(call.peer, stream);
    });

    call.on('close', () => {
        removeVideo(call.peer);
        delete peers[call.peer];
    });
}

function setupData(conn) {
    dataChannels[conn.peer] = conn;

    conn.on('data', data => {
        if (data.type === 'chat') addMessage(data.name + ': ' + data.text);
        if (data.type === 'kick' && data.target === peer.id) location.reload();
        if (data.type === 'mute' && data.target === peer.id) {
            myStream.getAudioTracks()[0].enabled = false;
        }
    });
}

function connect() {
    const id = connectId.value;
    isHost = false;

    const call = peer.call(id, myStream);
    setupCall(call);

    const conn = peer.connect(id);
    setupData(conn);
}

function toggleMic() {
    const track = myStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
}

async function shareScreen() {
    if (screenStream) {
        screenStream.getTracks().forEach(t => t.stop());
        screenStream = null;
        return;
    }

    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });

    for (let id in peers) {
        peer.call(id, screenStream);
    }
}

function sendMessage(e) {
    if (e.key !== 'Enter') return;
    const text = e.target.value;
    const name = document.getElementById('name').value || 'User';

    addMessage('–Ø: ' + text);

    for (let id in dataChannels) {
        dataChannels[id].send({ type: 'chat', name, text });
    }
    e.target.value = '';
}

function addMessage(text) {
    const div = document.createElement('div');
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function addVideo(id, stream) {
    if (document.getElementById(id)) return;
    const video = document.createElement('video');
    video.id = id;
    video.autoplay = true;
    video.srcObject = stream;
    videos.appendChild(video);
}

function removeVideo(id) {
    const v = document.getElementById(id);
    if (v) v.remove();
}
</script>
</body>
</html>
