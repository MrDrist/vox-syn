<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Vox Syn P2P</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
  #videos { display: flex; flex-wrap: wrap; gap: 10px; }
  video { width: 300px; height: 200px; background: black; }
  #chat { margin-top: 20px; }
  #chatMessages { height: 150px; overflow-y: auto; background: #fff; padding: 5px; border: 1px solid #ccc; }
  #chatInput { width: 80%; }
</style>
</head>
<body>

<h1>Vox Syn P2P</h1>

<div>
  <button id="startBtn">Начать P2P</button>
  <button id="shareScreenBtn">Поделиться экраном</button>
</div>

<div id="videos"></div>

<div id="chat">
  <h3>Чат</h3>
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Написать сообщение..." />
  <button id="sendBtn">Отправить</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

// ==================== CONFIG FIREBASE ====================
const firebaseConfig = {
  apiKey: "AIzaSyDuvwoM4s3EzM1tSRiyvhKFlkNsLlMNIbE",
  authDomain: "vox-signal.firebaseapp.com",
  databaseURL: "https://vox-signal-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "vox-signal",
  storageBucket: "vox-signal.firebasestorage.app",
  messagingSenderId: "410698338678",
  appId: "1:410698338678:web:316010281098e78af4ea57"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==================== ИНИЦИАЛИЗАЦИЯ P2P ====================
const peerId = Math.random().toString(36).substring(2, 10);
const roomId = "testRoom";
const peersRef = ref(db, `rooms/${roomId}/peers`);
const signalsRef = ref(db, `rooms/${roomId}/signals/${peerId}`);

// Добавляем себя в комнату
set(ref(db, `rooms/${roomId}/peers/${peerId}`), { joinedAt: Date.now() });
window.addEventListener("beforeunload", () => {
  remove(ref(db, `rooms/${roomId}/peers/${peerId}`));
});

// ==================== ЛОКАЛЬНОЕ ВИДЕО ====================
const videosDiv = document.getElementById("videos");
let localStream;
let pcs = {}; // хранилище peer connections

async function startP2P() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  addVideo(peerId, localStream, true);

  // Слушаем других участников
  onChildAdded(peersRef, snapshot => {
    const otherPeerId = snapshot.key;
    if (otherPeerId !== peerId && !pcs[otherPeerId]) {
      console.log("Подключаемся к:", otherPeerId);
      createConnection(otherPeerId, true);
    }
  });

  // Слушаем сигналы
  onChildAdded(signalsRef, snapshot => {
    const signal = snapshot.val();
    const from = signal.from;
    if (!pcs[from]) createConnection(from, false, signal);
    else pcs[from].pc.setRemoteDescription(signal.sdp).catch(console.error);
    if (signal.candidate) pcs[from].pc.addIceCandidate(signal.candidate).catch(console.error);
  });
}

// ==================== СОЗДАНИЕ PEER CONNECTION ====================
function createConnection(otherPeerId, isInitiator, signal) {
  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  pcs[otherPeerId] = { pc };

  // Добавляем локальный поток
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Получение удалённого видео
  pc.ontrack = event => {
    addVideo(otherPeerId, event.streams[0], false);
  };

  // ICE candidates
  pc.onicecandidate = event => {
    if (event.candidate) {
      push(ref(db, `rooms/${roomId}/signals/${otherPeerId}`), {
        from: peerId,
        candidate: event.candidate
      });
    }
  };

  // Если инициатор — создаём оффер
  if (isInitiator) {
    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      push(ref(db, `rooms/${roomId}/signals/${otherPeerId}`), {
        from: peerId,
        sdp: offer
      });
    });
  } else if (signal && signal.sdp) {
    pc.setRemoteDescription(signal.sdp).then(() => {
      pc.createAnswer().then(answer => {
        pc.setLocalDescription(answer);
        push(ref(db, `rooms/${roomId}/signals/${otherPeerId}`), {
          from: peerId,
          sdp: answer
        });
      });
    });
  }
}

// ==================== ФУНКЦИИ UI ====================
function addVideo(id, stream, isLocal) {
  let vid = document.getElementById(id);
  if (!vid) {
    vid = document.createElement("video");
    vid.id = id;
    vid.autoplay = true;
    vid.playsInline = true;
    if (isLocal) vid.muted = true;
    videosDiv.appendChild(vid);
  }
  vid.srcObject = stream;
}

// ==================== ЧАТ ====================
const chatInput = document.getElementById("chatInput");
const chatMessages = document.getElementById("chatMessages");
document.getElementById("sendBtn").onclick = () => {
  const msg = chatInput.value.trim();
  if (!msg) return;
  for (let p in pcs) {
    pcs[p].dc.send(JSON.stringify({ from: peerId, text: msg }));
  }
  addChatMessage("Я", msg);
  chatInput.value = "";
};

function addChatMessage(sender, text) {
  const div = document.createElement("div");
  div.textContent = `${sender}: ${text}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ==================== DATA CHANNEL ====================
function createDataChannel(pc, otherPeerId) {
  const dc = pc.createDataChannel("chat");
  pcs[otherPeerId].dc = dc;
  dc.onmessage = e => {
    const data = JSON.parse(e.data);
    addChatMessage(data.from, data.text);
  };
}

// ==================== ПОДЕЛИТЬСЯ ЭКРАНОМ ====================
document.getElementById("shareScreenBtn").onclick = async () => {
  const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  for (let p in pcs) {
    const pc = pcs[p].pc;
    const sender = pc.getSenders().find(s => s.track.kind === "video");
    sender.replaceTrack(screenStream.getVideoTracks()[0]);
  }
};

// ==================== КНОПКИ ====================
document.getElementById("startBtn").onclick = startP2P;

</script>
</body>
</html>
