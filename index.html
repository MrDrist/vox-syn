<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vox Syn Text Chat</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e2f;
      color: #fff;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      display: flex;
      gap: 20px;
    }
    #auth, #login, #room {
      display: none;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    input {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      width: 250px;
      text-align: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      background: #4c4cff;
      color: #fff;
      transition: 0.2s;
    }
    button:hover {
      background: #5d5dff;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    
    /* Room layout */
    #room {
      display: flex;
      width: 100%;
      gap: 20px;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chatMessages {
      flex: 1;
      height: 400px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #555;
      background: #2c2c44;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #chatInputContainer {
      display: flex;
      gap: 5px;
    }
    #chatInput {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }
    #sendBtn {
      padding: 8px 16px;
    }
    
    /* Participants sidebar */
    #participantsPanel {
      width: 220px;
      background: #2c2c44;
      padding: 15px;
      border-radius: 8px;
    }
    #participantsPanel h3 {
      margin-top: 0;
      border-bottom: 1px solid #555;
      padding-bottom: 8px;
    }
    #participantsList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #participantsList li {
      padding: 6px 0;
      border-bottom: 1px solid #3a3a55;
      font-size: 14px;
    }
    .online { color: #55ff55; }
    .offline { color: #888; }
    
    #errorMsg {
      color: #ff5555;
      text-align: center;
      margin-top: 10px;
    }
    .toggle-link {
      color: #4c4cff;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="width: 100%;">
      <h1>Vox Syn Text Chat</h1>

      <!-- Auth Screen -->
      <div id="auth">
        <div class="form-group">
          <input id="emailInput" type="email" placeholder="Email" />
          <input id="passwordInput" type="password" placeholder="Пароль" />
          <button id="signInBtn">Войти</button>
          <button id="signUpBtn">Зарегистрироваться</button>
          <div>
            <span class="toggle-link" id="toggleToSignUp">Нет аккаунта?</span>
            <span class="toggle-link" id="toggleToSignIn" style="display:none;">Уже есть аккаунт?</span>
          </div>
          <div id="errorMsg"></div>
        </div>
      </div>

      <!-- Room Join/Create -->
      <div id="login">
        <input id="nameInput" placeholder="Ваше имя в чате" maxlength="20" />
        <div>
          <button id="createBtn">Создать комнату</button>
          <button id="joinBtn">Подключиться</button>
        </div>
        <input id="roomInput" placeholder="Код комнаты" style="display: none; margin-top: 10px;" maxlength="10" />
        <div id="errorMsg2"></div>
      </div>

      <!-- Room -->
      <div id="room">
        <div id="chatArea">
          <h2>Комната: <span id="roomCode"></span></h2>
          <div id="chatMessages"></div>
          <div id="chatInputContainer">
            <input id="chatInput" placeholder="Написать сообщение..." maxlength="200" />
            <button id="sendBtn">Отправить</button>
          </div>
        </div>
        <div id="participantsPanel">
          <h3>Участники</h3>
          <ul id="participantsList"></ul>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // === Firebase SDK ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onChildAdded,
      onChildRemoved,
      get,
      remove
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyDuvwoM4s3EzM1tSRiyvhKFlkNsLlMNIbE",
      authDomain: "vox-signal.firebaseapp.com",
      databaseURL: "https://vox-signal-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "vox-signal",
      storageBucket: "vox-signal.firebasestorage.app",
      messagingSenderId: "410698338678",
      appId: "1:410698338678:web:316010281098e78af4ea57"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // === State ===
    let displayName = "";
    let roomId = "";
    let userId = null;

    // === UI ===
    const authDiv = document.getElementById("auth");
    const loginDiv = document.getElementById("login");
    const roomDiv = document.getElementById("room");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const roomCodeSpan = document.getElementById("roomCode");
    const participantsList = document.getElementById("participantsList");
    const errorMsg = document.getElementById("errorMsg");
    const errorMsg2 = document.getElementById("errorMsg2");

    // === Auth UI ===
    document.getElementById("toggleToSignUp").onclick = () => {
      document.getElementById("signUpBtn").style.display = "block";
      document.getElementById("signInBtn").style.display = "none";
      document.getElementById("toggleToSignUp").style.display = "none";
      document.getElementById("toggleToSignIn").style.display = "inline";
    };
    document.getElementById("toggleToSignIn").onclick = () => {
      document.getElementById("signInBtn").style.display = "block";
      document.getElementById("signUpBtn").style.display = "none";
      document.getElementById("toggleToSignIn").style.display = "none";
      document.getElementById("toggleToSignUp").style.display = "inline";
    };

    // === Auth Functions ===
    function showError(msg) {
      errorMsg.textContent = msg;
      setTimeout(() => errorMsg.textContent = "", 5000);
    }
    function showError2(msg) {
      errorMsg2.textContent = msg;
      setTimeout(() => errorMsg2.textContent = "", 5000);
    }

    document.getElementById("signUpBtn").onclick = async () => {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      if (!email || !password) return showError("Введите email и пароль");
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        if (err.code === "auth/weak-password") {
          showError("Пароль слишком короткий (мин. 6 символов)");
        } else if (err.code === "auth/email-already-in-use") {
          showError("Email уже используется");
        } else if (err.code === "auth/invalid-email") {
          showError("Неверный формат email");
        } else if (err.code === "auth/operation-not-allowed") {
          showError("Регистрация отключена в Firebase Console");
        } else {
          showError("Ошибка: " + err.message);
        }
      }
    };

    document.getElementById("signInBtn").onclick = async () => {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      if (!email || !password) return showError("Введите email и пароль");
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        if (err.code === "auth/user-not-found" || err.code === "auth/wrong-password") {
          showError("Неверный email или пароль");
        } else if (err.code === "auth/invalid-email") {
          showError("Неверный формат email");
        } else {
          showError("Ошибка: " + err.message);
        }
      }
    };

    // === Auth State ===
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        authDiv.style.display = "none";
        loginDiv.style.display = "block";
      } else {
        authDiv.style.display = "block";
        loginDiv.style.display = "none";
        roomDiv.style.display = "none";
      }
    });

    // === Room UI ===
    document.getElementById("createBtn").onclick = () => {
      displayName = document.getElementById("nameInput").value.trim();
      if (!displayName) return showError2("Введите имя в чате");
      roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      enterRoom(true);
    };

    document.getElementById("joinBtn").onclick = () => {
      document.getElementById("roomInput").style.display = "block";
    };

    document.getElementById("roomInput").addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        displayName = document.getElementById("nameInput").value.trim();
        roomId = document.getElementById("roomInput").value.trim().toUpperCase();
        if (!displayName || !roomId) return showError2("Введите имя и код комнаты");
        const roomExists = (await get(ref(db, `rooms/${roomId}`))).exists();
        if (!roomExists) return showError2("Комната не найдена");
        enterRoom(false);
      }
    });

    // === Enter Room ===
    async function enterRoom(isNew) {
      loginDiv.style.display = "none";
      roomDiv.style.display = "flex";
      roomCodeSpan.textContent = roomId;

      if (isNew) {
        await set(ref(db, `rooms/${roomId}`), { createdAt: Date.now() });
      }

      // Add self to peers
      await set(ref(db, `rooms/${roomId}/peers/${userId}`), {
        name: displayName,
        joinedAt: Date.now()
      });

      // Cleanup on leave
      window.addEventListener("beforeunload", () => {
        remove(ref(db, `rooms/${roomId}/peers/${userId}`));
        cleanupRoom();
      });

      // Listen to messages
      const messagesRef = ref(db, `rooms/${roomId}/messages`);
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        addChatMessage(msg.name, msg.text, msg.timestamp);
      });

      // Listen to peers (participants)
      const peersRef = ref(db, `rooms/${roomId}/peers`);
      onChildAdded(peersRef, (snapshot) => {
        const peerId = snapshot.key;
        const peer = snapshot.val();
        addParticipant(peerId, peer.name);
      });
      onChildRemoved(peersRef, (snapshot) => {
        removeParticipant(snapshot.key);
      });

      // Load existing peers
      const peersSnap = await get(peersRef);
      if (peersSnap.exists()) {
        participantsList.innerHTML = "";
        peersSnap.forEach(child => {
          addParticipant(child.key, child.val().name);
        });
      }
    }

    // === Chat Functions ===
    document.getElementById("sendBtn").onclick = sendMessage;
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      await push(ref(db, `rooms/${roomId}/messages`), {
        name: displayName,
        text: text,
        userId: userId,
        timestamp: Date.now()
      });
      chatInput.value = "";
    }

    function addChatMessage(name, text, timestamp) {
      const div = document.createElement("div");
      const time = new Date(timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      div.innerHTML = `<b>${name}</b> <small>[${time}]</small><br>${text}`;
      div.style.marginBottom = "10px";
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // === Participants ===
    function addParticipant(id, name) {
      if (document.getElementById(`peer-${id}`)) return;
      const li = document.createElement("li");
      li.id = `peer-${id}`;
      li.textContent = name;
      li.className = "online";
      participantsList.appendChild(li);
    }

    function removeParticipant(id) {
      const el = document.getElementById(`peer-${id}`);
      if (el) el.remove();
    }

    async function cleanupRoom() {
      const peersSnap = await get(ref(db, `rooms/${roomId}/peers`));
      if (!peersSnap.exists()) {
        await remove(ref(db, `rooms/${roomId}`));
      }
    }

    // === Logout button ===
    const logoutBtn = document.createElement("button");
    logoutBtn.textContent = "Выйти";
    logoutBtn.style.marginTop = "10px";
    logoutBtn.onclick = () => signOut(auth);
    document.querySelector(".container").appendChild(logoutBtn);
  </script>
</body>
</html>
